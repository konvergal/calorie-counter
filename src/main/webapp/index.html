<!DOCTYPE html>
<html lang="en">
<title>Calorie counter</title>
<head>
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"
          integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ=="
          crossorigin="anonymous">

    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css"
          integrity="sha384-aUGj/X2zp5rLCbBxumKTCw2Z50WgIr1vs/PFN4praOTvYXWlVyh2UtNUU0KAUhAX"
          crossorigin="anonymous">
</head>

<body>

<div class="container">

<div class="alert alert-danger" id="alert-danger" role="alert" style="display: none;"></div>

<div class="alert alert-success" id="alert-success" role="alert" style="display: none;"></div>

<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">New calorie entry</h3>
    </div>
    <div class="panel-body">

        <form id="add-form" class="form-horizontal">
            <div class="form-group">
                <label for="meal" class="col-sm-2 control-label">Meal</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="meal" placeholder="Meal" />
                </div>
            </div>
            <div class="form-group">
                <label for="number-of-calories" class="col-sm-2 control-label">Number of calories</label>
                <div class="col-sm-10">
                    <input type="number" class="form-control" id="number-of-calories" placeholder="Number of calories" />
                </div>
            </div>
            <div class="form-group">
                <label for="date-time" class="col-sm-2 control-label">Date and time</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="date-time" />
                </div>
            </div>
                <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                    <button type="submit" class="btn btn-default">Add</button>
                </div>
            </div>
        </form>

    </div>
</div>

<div class="modal fade" id="edit-modal">
    <div class="modal-dialog" style="width: 700px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Edit</h4>
            </div>
            <form id="edit-form" class="form-horizontal" data-id="">
            <div class="modal-body">
                    <div class="form-group">
                        <label for="meal" class="col-sm-3 control-label">Meal</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="edit-meal" placeholder="Meal" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="number-of-calories" class="col-sm-3 control-label">Number of calories</label>
                        <div class="col-sm-9">
                            <input type="number" class="form-control" id="edit-number-of-calories" placeholder="Number of calories" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="date-time" class="col-sm-3 control-label">Date and time</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="edit-date-time" />
                        </div>
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary">Save changes</button>
            </div>
            </form>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">Calorie entries</h3>
    </div>

    <div class="panel-body">
        <form class="form-inline" id="filter-form">
            <div class="form-group">
                <label for="filter-from">From</label>
                <input type="text" class="form-control" name="from" id="filter-from" placeholder="From" style="width: 200px;">
            </div>
            <div class="form-group">
                <label for="filter-to">To</label>
                <input type="text" class="form-control" name="to" id="filter-to" placeholder="To" style="width: 200px;">
            </div>
            <button type="submit" class="btn btn-default">Filter</button>
        </form>
    </div>

    <table id="calorieEntryTable" class="table table-striped table-bordered table-hover no-footer" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th>Meal</th>
                <th>Number of calories</th>
                <th>Date and time</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="calorie-entry-table-body">

        </tbody>
    </table>

</div>

</div>

<script src="https://code.jquery.com/jquery-2.1.4.min.js"
        integrity="sha384-R4/ztc4ZlRqWjqIuvf6RX5yb/v90qNGx6fS48N0tRxiGkqveZETq72KgDVJCp2TC"
        crossorigin="anonymous"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"
        integrity="sha512-K1qjQ+NcF2TYO/eI3M6v8EiNYZfA95pQumfvcVrTHtwQVDG+aHRqLi/ETn2uB+1JqwYqVG3LIvdm9lj6imS/pQ=="
        crossorigin="anonymous"></script>

<script src="calorie.js"></script>

<script type="text/javascript">

function clearCalorieForm() {
    $("#add-form input").val("");
}

function getRowAndId(element) {
    var tr = element.closest("tr");
    var dataId = tr.attr("data-id");
    return { row : tr, id : dataId };
}

function registerDeleteHandler(deleteLink) {
    deleteLink.click(function(event) {
        event.preventDefault();

        var rowAndId = getRowAndId($(this));
        $.ajax({
            type: 'DELETE',
            url: '/api/calories/' + rowAndId.id,
            contentType: "application/json; charset=utf-8"

        }).done(function (data, textStatus, jqXHR) {
            rowAndId.row.remove();
            successMsg("Calorie entry deleted!");

        }).fail(function (jqXHR, textStatus, errorThrown) {
            errorMsg("Unable to delete the calorie entry!");
            console.error(jqXHR);
        });
    });
}

function registerEditHandler(editLink) {
    editLink.click(function(event) {
        event.preventDefault();

        var tds = $(this).closest("tr").find("td");
        $("#edit-form").attr('data-id', getRowAndId($(this)).id);
        $("#edit-meal").val($(tds.get(0)).text());
        $("#edit-number-of-calories").val($(tds.get(1)).text());
        $("#edit-date-time").val($(tds.get(2)).text());

        $("#edit-modal").modal('show');
    });
}

function createCalorieRow(calorieEntry) {
    var tr = $("<tr/>", { 'data-id':calorieEntry.id });
    $("<td/>", { 'text':calorieEntry.meal } ).appendTo(tr);
    $("<td/>", { 'text':calorieEntry.numberOfCalories } ).appendTo(tr);
    $("<td/>", { 'text':calorieEntry.dateTime } ).appendTo(tr);
    var lastColumn = $("<td/>").appendTo(tr);
    registerEditHandler($("<a href=\"#\" class=\"edit\">Edit</a>").appendTo(lastColumn));
    lastColumn.append("&nbsp;");
    registerDeleteHandler($("<a href=\"#\" class=\"delete\">Delete</a>").appendTo(lastColumn));
    return tr;
}

function buildCalorieEntryTable(data) {
    console.log(data);
    $("#calorie-entry-table-body").html("");
    for (i = 0; i < data.length; i++) {
        var calorieEntry = data[i];
        var tr = createCalorieRow(calorieEntry);
        tr.appendTo("#calorie-entry-table-body");
    }
}

function getFilterUrlParameters() {
    console.log($("#filter-form").serializeArray());
    var parameters = $.param($("#filter-form").serializeArray());
    console.log(parameters);
    return parameters;
}

function getCalories() {
    $.ajax({
            type: 'GET',
            url: '/api/calories?' + getFilterUrlParameters(),
            contentType: "application/json; charset=utf-8"

        }).done(function (data, textStatus, jqXHR) {
            buildCalorieEntryTable(data);

        }).fail(function (jqXHR, textStatus, errorThrown) {
            if (jqXHR.status === 403) {
                window.location = "login.html";
            } else {
                errorMsg("Unable to get calorie entries!");
                console.error(jqXHR);
            }
        });
}

$(function() {
    $("#add-form").submit(
        function(event) {
            event.preventDefault();

            $.ajax({
                    type: 'POST',
                    url: '/api/calories?' + getFilterUrlParameters(),
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(
                            { "numberOfCalories" : $("#number-of-calories").val(),
                              "meal" : $("#meal").val(),
                              "dateTime" : $("#date-time").val() })

                }).done(function (data, textStatus, jqXHR) {
                    clearCalorieForm();
                    successMsg("Calorie entry added.");
                    buildCalorieEntryTable(data);
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    errorMsg("Unable to add calorie entry!");
                    console.error(jqXHR);
                });
        }
    );

    $("#filter-form").submit(
        function(event) {
            event.preventDefault();
            getCalories();
        }
    );

    $("#edit-form").submit(
        function(event) {
            event.preventDefault();

            var dataObject = { "id" : $("#edit-form").attr("data-id"),
                              "numberOfCalories" : $("#edit-number-of-calories").val(),
                              "meal" : $("#edit-meal").val(),
                              "dateTime" : $("#edit-date-time").val() };

            $.ajax({
                    type: 'PUT',
                    url: '/api/calories',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(dataObject)

                }).done(function (data, textStatus, jqXHR) {
                    $("#edit-modal").modal('hide');
                    $("tr[data-id='" + dataObject.id + "']").replaceWith(createCalorieRow(dataObject));
                    successMsg("Calorie entry edited.");
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    errorMsg("Unable to edit calorie entry!");
                    console.error(jqXHR);
                });
        }
    );

    getCalories();
});

</script>

</body>

</html>