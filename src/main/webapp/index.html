<!DOCTYPE html>
<html lang="en">
<title>Calorie counter</title>
<head>
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"
          integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ=="
          crossorigin="anonymous">

    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css"
          integrity="sha384-aUGj/X2zp5rLCbBxumKTCw2Z50WgIr1vs/PFN4praOTvYXWlVyh2UtNUU0KAUhAX"
          crossorigin="anonymous">
</head>

<body>

<div class="container">

<div class="alert alert-danger" id="alert-danger" role="alert" style="display: none;"></div>

<div class="alert alert-success" id="alert-success" role="alert" style="display: none;"></div>

<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">New calorie entry</h3>
    </div>
    <div class="panel-body">

        <form id="calorie-form" class="form-horizontal">
            <div class="form-group">
                <label for="meal" class="col-sm-2 control-label">Meal</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="meal" placeholder="Meal" />
                </div>
            </div>
            <div class="form-group">
                <label for="number-of-calories" class="col-sm-2 control-label">Number of calories</label>
                <div class="col-sm-10">
                    <input type="number" class="form-control" id="number-of-calories" placeholder="Number of calories" />
                </div>
            </div>
            <div class="form-group">
                <label for="date-time" class="col-sm-2 control-label">Date and time</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="date-time" />
                </div>
            </div>
                <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                    <button type="submit" class="btn btn-default">Add</button>
                </div>
            </div>
        </form>

    </div>
</div>

<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">Calorie entries</h3>
    </div>
    <table id="calorieEntryTable" class="table table-striped table-bordered table-hover no-footer" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th>Meal</th>
                <th>Number of calories</th>
                <th>Date and time</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="calorie-entry-table-body">

        </tbody>
    </table>
</div>

</div>

<script src="https://code.jquery.com/jquery-2.1.4.min.js"
        integrity="sha384-R4/ztc4ZlRqWjqIuvf6RX5yb/v90qNGx6fS48N0tRxiGkqveZETq72KgDVJCp2TC"
        crossorigin="anonymous"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"
        integrity="sha512-K1qjQ+NcF2TYO/eI3M6v8EiNYZfA95pQumfvcVrTHtwQVDG+aHRqLi/ETn2uB+1JqwYqVG3LIvdm9lj6imS/pQ=="
        crossorigin="anonymous"></script>

<script src="calorie.js"></script>

<script type="text/javascript">

function clearCalorieForm() {
    $("#calorie-form input").val("");
}

function registerDeleteHandler() {
    $("#calorie-entry-table-body .delete").click(function(event) {
        event.preventDefault();

        var tr = $(this).closest("tr");
        var id = tr.attr("data-id");
        $.ajax({
            type: 'DELETE',
            url: '/api/calories/' + id,
            contentType: "application/json; charset=utf-8"

        }).done(function (data, textStatus, jqXHR) {
            tr.remove();
            successMsg("Calorie entry deleted!");

        }).fail(function (jqXHR, textStatus, errorThrown) {
            errorMsg("Unable to delete the calorie entry!");
            console.error(jqXHR);
        });
    });
}

function buildCalorieEntryTable(data) {
    console.log(data);
    $("#calorie-entry-table-body").html("");
    for (i = 0; i < data.length; i++) {
        var calorieEntry = data[i];
        var tr = $("<tr/>", { 'data-id':calorieEntry.id }).appendTo("#calorie-entry-table-body");
        $("<td/>", { 'text':calorieEntry.meal } ).appendTo(tr);
        $("<td/>", { 'text':calorieEntry.numberOfCalories } ).appendTo(tr);
        $("<td/>", { 'text':calorieEntry.dateTime } ).appendTo(tr);
        var lastColumn = $("<td/>").appendTo(tr);
        $("<a href=\"#\" class=\"delete\">Delete</a>").appendTo(lastColumn);
    }
    registerDeleteHandler();
}

$(function() {
    $("#calorie-form").submit(
        function(event) {
            event.preventDefault();

            $.ajax({
                    type: 'POST',
                    url: '/api/calories',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(
                            { "numberOfCalories" : $("#number-of-calories").val(),
                              "meal" : $("#meal").val(),
                              "dateTime" : $("#date-time").val() })

                }).done(function (data, textStatus, jqXHR) {
                    clearCalorieForm();
                    successMsg("Calorie entry added.");
                    buildCalorieEntryTable(data);
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    errorMsg("Unable to add calorie entry!");
                    console.error(jqXHR);
                });
        }
    );

    $.ajax({
            type: 'GET',
            url: '/api/calories',
            contentType: "application/json; charset=utf-8"

        }).done(function (data, textStatus, jqXHR) {
            buildCalorieEntryTable(data);

        }).fail(function (jqXHR, textStatus, errorThrown) {
            if (jqXHR.status === 403) {
                window.location = "login.html";
            } else {
                errorMsg("Unable to get calorie entries!");
                console.error(jqXHR);
            }
        });
});

</script>

</body>

</html>